
WhatsApp Multi Session Server – це серверний додаток на Node.js, який забезпечує інтеграцію з WhatsApp через ASP.NET. Він використовує модулі express, whatsapp-web.js, node-fetch та власний логер для обробки сесій, обміну повідомленнями та логування. Програма налаштовується через .env, підтримує кілька номерів, автоматично відновлюється після збоїв і є ідеальним рішенням для автоматизації спілкування в бізнесі.

Програма WhatsApp Multi Session Server призначена для інтеграції з WhatsApp через бібліотеку whatsapp-web.js, забезпечуючи автоматизований обмін повідомленнями. 
Вона дозволяє:
1. Реєструвати та ініціалізувати WhatsApp-сесії для різних телефонних номерів.
2. Отримувати вхідні повідомлення (текст, медіа, реакції) і передавати їх до ASP.NET через вебхуки.
3. Відправляти повідомлення (текст або медіа) від імені зареєстрованих номерів через запити від ASP.NET.
4. Управляти сесіями (перевірка статусу, видалення сесій).
5. Логувати всі дії та помилки для подальшого аналізу.

Ця програма корисна для бізнесів, які хочуть автоматизувати спілкування з клієнтами через WhatsApp, наприклад, для підтримки клієнтів, інтеграції з CRM-системами (як Bitrix), або створення чат-ботів.


Основні файли:
1. index.js – основний файл програми, який містить логіку сервера, ініціалізацію клієнтів WhatsApp, обробку  запитів і подій.                  
2. logger.js – модуль для логування подій із підтримкою різних рівнів логування та кольорового виведення в консоль.
3. package.json – файл конфігурації проєкту, що містить метадані, залежності та скрипти.
4. .env - Налаштування змінних середовища


Налаштування програми:
1. Встановлення Node.js і npm:
     Встановіть Node.js (рекомендується версія 16.x або новіша) та npm.
     Перевірте встановлення командою:
     node -v && npm -v

2. Клонування проєкту:
     Склонуйте або створіть проєкт у локальній директорії.

3. Встановлення залежностей:
     У директорії проєкту виконайте:
     npm install
     Це встановить усі залежності, перелічені в package.json.

4. Налаштування змінних середовища (.env):
     Створіть файл .env у корені проєкту.
     Додайте наступні змінні:
     BASE_URL=http://your-asp-net-server:port - адреса вашого сервера куди передаються дані
     LOG_DIR=Logs - директорія для збереження логів (наприклад, Logs)
     PORT=3000 - порт на якому працює цей сервер http://localhost:3000

5. Запуск програми:
     node index.js

     Програма запуститься і виведе в консоль повідомлення:
     [2025-05-24 08:43] [INFO] WhatsApp Multi Session Server запущено на порті 3000

6. Налаштування ASP.NET:
    На стороні ASP.NET налаштуйте ендпоінт /whatsapp?handler=RegisteredPhones для повернення списку зареєстрованих номерів.
    Налаштуйте вебхук /whatsappwebhook для обробки вхідних повідомлень від WhatsApp.
    Налаштуйте ендпоінт /whatsapp?handler=NotifyAuthSuccess для повідомлення про успішну аутентифікацію.


                                    Функції програми
1. Ініціалізація та управління сесіями WhatsApp:
     Реєстрація нового номера: Через ендпоінт POST /registerwhatsapp можна зареєструвати новий номер телефону  для WhatsApp. Програма генерує QR-код для аутентифікації.
2. Ініціалізація сесій: При старті сервера програма автоматично ініціалізує сесії для всіх зареєстрованих 
     номерів, отриманих від ASP.NET через fetchRegisteredPhones.
3. Перевірка статусу сесії: Ендпоінт GET /status/:phone повертає статус сесії (підключена чи ні).
4. Видалення сесії: Ендпоінт DELETE /sessiondelete/:phone видаляє сесію та пов’язані файли (сесія, кеш).
5. Обмін повідомленнями:
    . Отримання повідомлень: Програма обробляє вхідні повідомлення (текст, медіа, реакції) через подію message у whatsapp-web.js. Підтримуються індивідуальні чати (@c.us). Повідомлення пересилаються до ASP.NET через вебхук /whatsappwebhook.
    . Відправлення повідомлень: Ендпоінт POST /sendmsg дозволяє відправляти повідомлення (текст або медіа) від імені зареєстрованого номера. Підтримуються файли до 16 МБ.
6. Логування:
   Програма записує всі події (інформація, помилки, успіхи) у файли логів, які створюються щодня (наприклад, 2025-05-24.log).
   Логи також виводяться в консоль із кольоровим форматуванням для зручності.
7. Обробка помилок:
   . Програма стійка до помилок завдяки try-catch у всіх критичних функціях.
     Неперехоплені помилки та відхилені обіцянки обробляються через uncaughtException і unhandledRejection, що дозволяє серверу продовжувати роботу.
   . Повторні спроби та відновлення:
     Якщо ініціалізація клієнта WhatsApp не вдається, програма автоматично перезапускає сесію через 30 секунд.
     Якщо не вдається отримати список номерів від ASP.NET, програма робить до 5 повторних спроб із затримкою 30 секунд.


Використані модулі:
Програма використовує наступні модулі Node.js, визначені в package.json:

1. dotenv (v16.5.0):
   Для завантаження змінних середовища з файлу .env.
   Використовується для конфігурації BASE_URL, LOG_DIR, PORT.
2. express (v5.1.0):
   Фреймворк для створення HTTP-сервера.
   Використовується для обробки запитів (наприклад, /registerwhatsapp, /sendmsg).
3. whatsapp-web.js (v1.28.0):
   Бібліотека для взаємодії з WhatsApp через API.
   Забезпечує ініціалізацію клієнтів, аутентифікацію, відправлення та отримання повідомлень.
4. qrcode (v1.5.4):
   Для генерації QR-кодів у форматі Data URL.
   Використовується для створення QR-кодів під час аутентифікації WhatsApp.
5. fs-extra (v11.3.0):
   Розширена версія модуля fs для роботи з файловою системою.
   Використовується для створення директорій сесій, кешу, збереження медіафайлів.
6. node-fetch (v2.7.0):
   Для виконання HTTP-запитів.
   Використовується для зв’язку з ASP.NET (наприклад, отримання списку номерів, відправлення повідомлень).
7. chalk (v4.1.2):
   Для кольорового форматування виведення в консоль.
   Використовується в logger.js для різних рівнів логування (Info, Error тощо).
8. body-parser (v2.2.0):
   Модуль для парсингу JSON у тілі HTTP-запитів.
   Використовується в express через app.use(express.json()).
9. form-data (v4.0.2):
   Для роботи з multipart/form-data.
   Може використовуватися для відправлення медіафайлів (хоча в коді поки не задіяний).
10. qrcode-terminal (v0.12.0):
   Для виведення QR-кодів у термінал (не використовується в коді, але є в залежностях).
11. ws (v8.18.2):
   Для роботи з WebSocket (можливо, потрібен для whatsapp-web.js, хоча в коді явно не використовується).
   Власний модуль
12. logger.js:
   Власний модуль для логування подій.
   Підтримує різні рівні логування (Info, Warning, Error, Success, Debug, Important).
   Зберігає логи у файли (по днях) та виводить їх у консоль із кольоровим форматуванням.